<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WhatsApp Baileys</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#198754,#20c997);
  color:#fff;
  padding:15px;
}
.container {
  max-width:480px;
  margin:auto;
}
input, button {
  width:100%;
  padding:12px;
  margin-top:10px;
  border-radius:8px;
  border:none;
  font-size:16px;
}
button { background:#ffc107; color:#000; cursor:pointer; }
button:disabled { background:#ccc; cursor:default; }

.box {
  background:#fff;
  color:#000;
  padding:12px;
  margin-top:12px;
  border-radius:10px;
}
#logs {
  max-height:200px;
  overflow:auto;
  font-size:13px;
}
.code {
  font-size:26px;
  text-align:center;
  letter-spacing:4px;
}
.expired {
  color:red;
  text-align:center;
}
</style>
</head>
<body>

<div class="container">
<h2>WhatsApp Sessão</h2>

<div class="box">
  <input id="session" placeholder="Nome da sessão">
  <button onclick="start()">Iniciar sessão</button>
</div>

<div id="phoneBox" class="box" style="display:none">
  <input id="phone" placeholder="Número (sem 0 e sem +258)">
  <button onclick="sendPhone()">Enviar número</button>
</div>

<div id="codeBox" class="box" style="display:none"></div>

<div id="infoBox" class="box" style="display:none"></div>

<div id="logs" class="box"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io()
let currentPhone = ''

function log(msg){
  logs.innerHTML += msg + '<br>'
  logs.scrollTop = logs.scrollHeight
}

// ===== Funções =====
function start(){
  if (!session.value) return alert('Digite o nome da sessão')
  socket.emit('start-session', session.value)
}

function sendPhone(){
  currentPhone = phone.value
  socket.emit('send-phone', { phone: currentPhone })
}

function renewCode(){
  socket.emit('renew-code')
}

// ===== Socket events =====
socket.on('log', log)

socket.on('request-phone', () => {
  phoneBox.style.display = 'block'
})

socket.on('pairing-code', d => {
  codeBox.style.display = 'block'
  codeBox.innerHTML = `
    <div class="code">${d.code}</div>
    <small>Digite este código no WhatsApp</small>
  `
})

socket.on('pairing-expired', () => {
  codeBox.innerHTML = `
    <div class="expired">Código expirou</div>
    <button onclick="renewCode()">Gerar novo código</button>
  `
})

socket.on('session-ready', d => {
  phoneBox.style.display = 'none'
  codeBox.style.display = 'none'

  infoBox.style.display = 'block'
  infoBox.innerHTML = `
    <b>${d.name}</b><br>
    Número: ${d.number}<br>
    <a href="${d.downloadUrl}" target="_blank">⬇️ Baixar ZIP da sessão</a>
    <hr>
    <b>Grupos Participantes:</b><br>
    ${d.groups.map(g => `${g.name} (${g.members} membros)`).join('<br>')}
  `
})
</script>

</body>
</html>
